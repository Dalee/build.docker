#!/usr/bin/env bash
set -eo pipefail

NULLMAIL_HOST_FINAL="127.0.0.1"
NULLMAIL_PORT_FINAL="--port=2525"
NULLMAIL_ME_FINAL="docker"

if [ ! -z "${NULLMAIL_HOST}" ]; then NULLMAIL_HOST_FINAL="${NULLMAIL_HOST}"; fi
if [ ! -z "${NULLMAIL_PORT}" ]; then NULLMAIL_PORT_FINAL="--port=${NULLMAIL_PORT}"; fi
if [ ! -z "${NULLMAIL_ME}" ]; then NULLMAIL_ME_FINAL="${NULLMAIL_ME}"; fi

echo "${NULLMAIL_HOST_FINAL} smtp ${NULLMAIL_PORT_FINAL}\n" > "/etc/nullmailer/remotes"
echo "${NULLMAIL_ME_FINAL}" > /etc/nullmailer/me

chown nobody:nogroup /etc/nullmailer/remotes /etc/nullmailer/me
chmod 0600 /etc/nullmailer/remotes /etc/nullmailer/me

exec /sbin/setuser nobody /usr/sbin/nullmailer-send >/dev/null 2>&1
