#!/usr/bin/env bash
set -eo pipefail

#
# if SENDMAIL_HOST is set, forward mail to that host.
# if SENDMAIL_PORT is set, use port from environment.
#
if [ -z "${SENDMAIL_HOST}" ]; then
    echo "==> Environment variable SENDMAIL_HOST is not set, skipping configuration..."
    exit 0
fi
if [ -z "${SENDMAIL_PORT}" ]; then
    SENDMAIL_PORT="25"
fi

SENDMAIL_EXTRA_CONF=""
if [ ! -z "${SENDMAIL_DOMAIN}" ]; then
    SENDMAIL_EXTRA_CONF="auto_from on\nmaildomain ${SENDMAIL_DOMAIN}"
fi

#
# create system-wide configuration file.
#
SENDMAIL_HOST=${SENDMAIL_HOST} \
SENDMAIL_PORT=${SENDMAIL_PORT} \
SENDMAIL_EXTRA_CONF=${SENDMAIL_EXTRA_CONF} \
envsubst <<"EOF" > /etc/msmtprc
defaults
account default
$SENDMAIL_EXTRA_CONF
host $SENDMAIL_HOST
port $SENDMAIL_PORT
EOF

#
# symlink /usr/sbin/sendmail => /usr/bin/msmtp
#
ln -s /usr/bin/msmtp /usr/sbin/sendmail
